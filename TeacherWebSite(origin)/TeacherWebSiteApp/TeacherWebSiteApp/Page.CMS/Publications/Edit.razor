@page "/cms/publication/{id:int}"
@inject IDbContextFactory<TeacherContext> DbFactory
@inject NavigationManager NavManager
@layout CmsLayout
@namespace TeacherWebSiteApp.Data.Models
@inject MessageService _message

<div class="container" style="margin-left:80px; margin-right:40%">

    <div class="col-md-6">
        <Form Layout="@FormLayout.Vertical"
              Model="@publication" OnFinish="SaveAsync">
            <div class="col-md-6">
                <FormItem Label="Название">
                    <Input @bind-Value="@context.Name" placeholder="Введите название публикации" />
                </FormItem>
            </div>
            <div class="col-md-6">
                <FormItem Label="Описание">
                    <TextArea Rows="4" Placeholder="Введите описание публикации" AutoSize="true" @bind-Value="@context.Text" />
                </FormItem>
            </div>
            <div class="container" style="margin-top:30px">
                <label>Вложение</label>
                <Row>
                    <AntDesign.Col>
                        <label>Название</label>
                        <Input Type="text" @bind-Value="attachment.Name" Class="form-control" Placeholder="Введите название">
                    </AntDesign.Col>
                    <AntDesign.Col style="margin-left: 50px">
                        <span>
                            <label>Ссылка</label>
                            <svg style="margin-top: 80px" onclick="alert('Инструкция')" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-question-circle" viewBox="0 0 16 16">
                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                                <path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z" />
                            </svg>
                        </span>
                        <Input Type="text" @bind-Value="attachment.Link" Class="form-control" Placeholder="Введите ссылку">
                    </AntDesign.Col>
                </Row>
            </div>
            <div class="form-block" style="margin-top:15px; margin-bottom:15px">
                <Button Type="button" Class="btn btn-success" @onclick="@AddAttachment">Добавить</Button>
                @*<ValidationBlock Messages="validationMessages" />*@
            </div>
        </Form>
        @if(publication.Attachments.Any())
        {
            <div class="form-block">
                <Table DataSource="publication.Attachments" TItem="Attachment" HidePagination="false">
                    <Column Title="Название" @bind-Field="@context.Name" TData="string" />
                    <Column Title="Ссылка" @bind-Field="@context.Link" TData="string" />
                    <Column Title=" " @bind-Field="@context.IsActive">
                        <Button @onclick="() => DeleteAttachment(context.Name, context.Link)"
                                Class="bg-danger">
                            Удалить
                        </Button>
                    </Column>

                </Table>
            </div>
        }

        @if (Id <= 0)
        {
            <Button Type="primary" Style="margin-bottom:30px" HtmlType="submit" @onclick="SaveAsync" Class="btn btn-block">Сохранить</Button>
        }
        else
        {
            <Row>
                <AntDesign.Col Style="margin-bottom:20px; margin-right:15px">
                    <Button Type="primary" @onclick="SaveAsync" HtmlType="submit">Сохранить</Button>
                </AntDesign.Col>
                <AntDesign.Col Style="margin-bottom:20px">
                    <Button @onclick="DeletePublication" Type="primary" Danger>Удалить</Button>
                </AntDesign.Col>
            </Row>
        }
    </div>

</div>
  

@code {
    [Parameter]
    public int Id { get; set; }

    private Attachment attachment = new Attachment();
    private TeacherWebSiteApp.Data.Models.Publication publication = new Publication()
    {
        Attachments = new List<TeacherWebSiteApp.Data.Models.Attachment>() { new() }
    };

    protected override async Task OnInitializedAsync()
    {
        if(Id != 0)
        {
            using TeacherContext context = DbFactory.CreateDbContext();
            publication = await context.Publications.FirstOrDefaultAsync(p => p.Id == Id);
            if(publication == null)
            {
                _message.Error("Публикация не найдена!");
                NavManager.NavigateTo("/cms/publication/0");
            }
        }
    }

    private async Task SaveAsync()
    {
        if (!publication.Attachments.Any())
        {
            _message.Error("Публикация должна содержать хотя бы одно вложение!");
        }

        try
        {
            using TeacherContext context = DbFactory.CreateDbContext();
            var selectedPublication = await context.Publications.Include(a => a.Attachments).FirstOrDefaultAsync(p => p.Id == Id);

            if(selectedPublication != null)
            {
                selectedPublication.Name = publication.Name;
                selectedPublication.Text = publication.Text;
                foreach(var i in selectedPublication.Attachments)
                {
                    publication.Attachments.Add(i);
                }


                var delAttachments = selectedPublication.Attachments.Where(b => !publication.Attachments.Any(x => x.Id == b.Id));

                var newAttachments = publication.Attachments.Where(b => !selectedPublication.Attachments.Any(x => x.Id == b.Id));

                var updBlocks = selectedPublication.Attachments.Where(b => publication.Attachments.Any(x => x.Id == b.Id))
                    .Select(db => new { Source = publication.Attachments.FirstOrDefault(x => x.Id == db.Id), Target = db });

                context.Attachments.RemoveRange(delAttachments);
                await context.Attachments.AddRangeAsync(newAttachments);
                updBlocks.ForEach(x =>
                {
                    x.Target.Name = x.Source.Name;
                    x.Target.Link = x.Source.Link;
                    x.Target.PublicationId = x.Source.PublicationId;
                    x.Target.ContentType = x.Source.ContentType;
                });

                await context.SaveChangesAsync();
                _message.Success("Публикация сохранена!");
            }
            else
            {
                publication.Date = DateTime.Now;
                context.Publications.Add(publication);
                await context.SaveChangesAsync();
                _message.Success("Публикация добавлена!");
            }

            NavManager.NavigateTo($"/cms/publication/{publication.Id}");
        }
        catch(Exception ex)
        {
            _message.Error(ex.Message, 60);
            _message.Error(ex.InnerException?.Message, 60);
            _message.Error("Во время сохранения публикации произошла ошибка", 60);
        }

    }

    private void AddAttachment()
    {
        publication.Attachments.Add(attachment);
        attachment = new();
    }

    private void DeleteAttachment(string name, string link)
    {
        var selectedAttachment = publication.Attachments.FirstOrDefault(x => x.Name == name && x.Link == link);
        publication.Attachments.Remove(selectedAttachment);
    }

    private void DeletePublication()
    {
        using TeacherContext context = DbFactory.CreateDbContext();
        context.Publications.Remove(publication);
        context.SaveChanges();
        NavManager.NavigateTo($"/cms/publications");
    }
}
